<!DOCTYPE html>
<html>

<head>
	<title>ESP32 LED Control</title>
</head>

<body>
	<h1>ESP32 LED Control zvx Web Bluetooth</h1>
	<button id="connect">Connect</button>
	<button id="reconnect">Reconnect</button>
	<button id="disconnect">Disconnect</button>
	<button id="led-on">LED ON</button>
	<button id="led-off">LED OFF</button>

	<script>
		const serviceUuid = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
		const characteristicUuid = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
		const option = { acceptAllDevices: true, optionalServices: [serviceUuid] };

		let characteristic;
		let device;

		async function connectGattServer(newDevice) {
			try {
				const server = await newDevice.gatt.connect();
				const service = await server.getPrimaryService(serviceUuid);
				characteristic = await service.getCharacteristic(characteristicUuid);

				newDevice.addEventListener('gattserverdisconnected', () => {
					console.log('Device disconnected, please use the Reconnect button to reconnect.');
					localStorage.removeItem('bluetoothDeviceId')
					characteristic = null;
					device = null;
				});
				newDevice = newDevice
				localStorage.setItem('bluetoothDeviceId', newDevice.id);
				console.log('Connected to BLE device');
			} catch (error) {
				console.error('Failed to connect GATT server', error);
			}
		}
		async function onConnect() {
			try {
				const newDevice = await navigator.bluetooth.requestDevice(option);
				await connectGattServer(newDevice);
				console.log('Connected to BLE device');
			} catch (error) {
				console.error('Connection failed', error);
			}
		}
		async function onReconnect() {
			const deviceId = localStorage.getItem('bluetoothDeviceId');
			if (!deviceId) return console.log('No stored device ID found for reconnection')
			if (device) return console.log("already connect")
			try {
				const newDevice = await navigator.bluetooth.requestDevice(option);
				await connectGattServer(newDevice);
			} catch (error) {
				console.error('Reconnection failed', error);
			}
		}
		async function onDisconnect() {
			if (device && device.gatt.connected) {
				device.gatt.disconnect();
				console.log('Device disconnected');
			} else console.log('No device is currently connected')
		}
		async function onCommand(command) {
			try {
				if (!characteristic) return console.error('device is not available')
				await characteristic.writeValue(new TextEncoder().encode(command));
				console.log(`${command} command sent`);
			} catch (error) {
				console.error(`Failed to send ${command} command`, error);
			}
		}
		async function onLoad() {
			const deviceId = localStorage.getItem('bluetoothDeviceId');
			if (deviceId) console.log('Found stored device')
		}
		document.getElementById('connect').addEventListener('click', onConnect);
		document.getElementById('reconnect').addEventListener('click', onReconnect);
		document.getElementById('disconnect').addEventListener('click', onDisconnect);
		document.getElementById('led-on').addEventListener('click', () => onCommand('LED ON'));
		document.getElementById('led-off').addEventListener('click', () => onCommand('LED OFF'));
		window.addEventListener('load', onLoad);
	</script>
</body>

</html>