<!DOCTYPE html>
<html>

<head>
	<title>ESP32 LED Control</title>
</head>

<body>
	<h1>ESP32 LED Control via Web Bluetooth</h1>
	<button id="connect">Connect</button>
	<button id="reconnect">Reconnect</button>
	<button id="disconnect">Disconnect</button>
	<button id="led-on">LED ON</button>
	<button id="led-off">LED OFF</button>

	<script>
		const serviceUuid = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
		const characteristicUuid = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';

		let characteristic;
		let device;

		async function connectToDevice() {
			try {
				device = await navigator.bluetooth.requestDevice({
					filters: [{ name: 'MyESP32' }],
					optionalServices: [serviceUuid]
				});

				await connectGattServer(device);
				console.log('Connected to BLE device');
			} catch (error) {
				console.error('Connection failed', error);
			}
		}

		async function connectGattServer(device) {
			try {
				localStorage.setItem('bluetoothDeviceId', device.id);
				const server = await device.gatt.connect();
				const service = await server.getPrimaryService(serviceUuid);
				characteristic = await service.getCharacteristic(characteristicUuid);

				device.addEventListener('gattserverdisconnected', handleDisconnection);
			} catch (error) {
				console.error('Failed to connect GATT server', error);
			}
		}

		function handleDisconnection() {
			console.log('Device disconnected, please use the Reconnect button to reconnect.');
		}

		async function attemptReconnect() {
			const deviceId = localStorage.getItem('bluetoothDeviceId');
			if (deviceId) {
				try {
					if (!device) {
						const options = {
							filters: [{ name: 'MyESP32' }],
							optionalServices: [serviceUuid]
						};
						navigator.bluetooth.requestDevice(options)
							.then(async (device) => {
								await connectGattServer(device);
								console.log('Reconnected to BLE device');
							})
							.catch(error => {
								console.error('Reconnection failed', error);
							});
					} else {
						await connectGattServer(device);
						console.log('Reconnected to BLE device');
					}
				} catch (error) {
					console.error('Reconnection failed', error);
				}
			} else {
				console.error('No stored device ID found for reconnection');
			}
		}

		async function disconnectDevice() {
			if (device && device.gatt.connected) {
				device.gatt.disconnect();
				console.log('Device disconnected');
			} else {
				console.log('No device is currently connected');
			}
		}

		async function sendCommand(command) {
			if (characteristic) {
				if (device.gatt.connected) {
					try {
						await characteristic.writeValue(new TextEncoder().encode(command));
						console.log(`${command} command sent`);
					} catch (error) {
						console.error(`Failed to send ${command} command`, error);
					}
				} else {
					console.log('Device is disconnected, attempting to reconnect');
					await attemptReconnect();
					if (device.gatt.connected) {
						try {
							await characteristic.writeValue(new TextEncoder().encode(command));
							console.log(`${command} command sent`);
						} catch (error) {
							console.error(`Failed to send ${command} command`, error);
						}
					}
				}
			} else {
				console.error('Characteristic is not available');
			}
		}

		document.getElementById('connect').addEventListener('click', connectToDevice);
		document.getElementById('reconnect').addEventListener('click', attemptReconnect);
		document.getElementById('disconnect').addEventListener('click', disconnectDevice);

		document.getElementById('led-on').addEventListener('click', async () => {
			await sendCommand('LED ON');
		});

		document.getElementById('led-off').addEventListener('click', async () => {
			await sendCommand('LED OFF');
		});

		window.addEventListener('load', () => {
			const deviceId = localStorage.getItem('bluetoothDeviceId');
			if (deviceId) {
				console.log('Found stored device ID:', deviceId);
			}
		});
	</script>
</body>

</html>