<!DOCTYPE html>
<html>

<head>
	<title>ESP32 LED Control</title>
</head>

<body>
	<h1>ESP32 LED Control via Web Bluetooth 2</h1>
	<button id="connect">Connect</button>
	<button id="led-on">LED ON</button>
	<button id="led-off">LED OFF</button>

	<script>
		const serviceUuid = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
		const characteristicUuid = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';

		let characteristic;
		let device;

		document.getElementById('connect').addEventListener('click', async () => {
			try {
				device = await navigator.bluetooth.requestDevice({
					filters: [{ name: 'MyESP32' }],
					optionalServices: [serviceUuid]
				});

				localStorage.setItem('bluetoothDeviceId', device.id);

				const server = await device.gatt.connect();
				const service = await server.getPrimaryService(serviceUuid);
				characteristic = await service.getCharacteristic(characteristicUuid);

				console.log('Connected to BLE device');
			} catch (error) {
				console.error('Connection failed', error);
			}
		});

		document.getElementById('led-on').addEventListener('click', async () => {
			if (characteristic) {
				await characteristic.writeValue(new TextEncoder().encode('LED ON'));
				console.log('LED ON command sent');
			}
		});

		document.getElementById('led-off').addEventListener('click', async () => {
			if (characteristic) {
				await characteristic.writeValue(new TextEncoder().encode('LED OFF'));
				console.log('LED OFF command sent');
			}
		});

		window.addEventListener('load', async () => {
			const deviceId = localStorage.getItem('bluetoothDeviceId');
			if (deviceId) {
				try {
					// Request device based on stored deviceId
					device = await navigator.bluetooth.requestDevice({
						filters: [{ services: [serviceUuid] }],
						acceptAllDevices: true,
						deviceId: deviceId  // Use stored deviceId to filter
					});

					// Connect to the device
					const server = await device.gatt.connect();
					const service = await server.getPrimaryService(serviceUuid);
					characteristic = await service.getCharacteristic(characteristicUuid);

					console.log('Reconnected to BLE device');
				} catch (error) {
					console.error('Reconnection failed', error);
				}
			}
		});

	</script>
</body>

</html>